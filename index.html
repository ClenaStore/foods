<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Clena Foods ‚Ä¢ Card√°pio & Pedidos</title>
  <meta name="description" content="Cat√°logo de produtos, complementos e pedidos com login por WhatsApp + senha, PIX e notifica√ß√µes." />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    :root{
      --bg:#0e0f12; --panel:#14161a; --soft:#1a1f27; --line:#262b36;
      --brand:#e63946; --brand-2:#ff8f1f; --txt:#f7f8fa; --muted:#cbd5e1;
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --shadow:0 12px 28px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1000px 600px at 10% -20%, rgba(230,57,70,.12), transparent),
                      radial-gradient(800px 500px at 110% 10%, rgba(255,143,31,.10), transparent), var(--bg);
      color:var(--txt);font-family:Inter, system-ui, Arial, sans-serif;}

    #desktopBlocker{position:fixed; inset:0; display:none; align-items:center; justify-content:center; text-align:center;
      padding:24px; background:linear-gradient(180deg,#0e0f12,#0b0c10); color:var(--txt); z-index:99999;}
    #desktopBlocker .box{max-width:560px; background:linear-gradient(180deg,#171a20,#14161b); border:1px solid var(--line); border-radius:16px; padding:24px; box-shadow:var(--shadow)}
    #desktopBlocker h1{margin:0 0 8px; font-size:22px} #desktopBlocker p{margin:0; color:var(--muted)}
    @media (min-width: 768px){ #app{display:none !important} #desktopBlocker{display:flex}}

    header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.2) blur(10px);
      background:linear-gradient(180deg, rgba(20,22,26,.92), rgba(20,22,26,.6)); border-bottom:1px solid var(--line)}
    .wrap{padding:12px 14px; display:flex; align-items:center; gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:34px;height:34px;border-radius:10px;box-shadow:var(--shadow)}
    .brand .t1{font-weight:800;letter-spacing:.2px;font-size:15px}
    .brand .t2{font-size:11px;color:var(--muted)}
    .actions{margin-left:auto; display:flex; align-items:center; gap:10px}
    .iconbtn{position:relative; display:grid; place-items:center; width:38px; height:38px; border-radius:12px;
      background:linear-gradient(180deg,#1a1f27,#14181f); border:1px solid var(--line); color:var(--txt); cursor:pointer}
    .badge{position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; padding:0 5px; background:linear-gradient(180deg,#f97316,#ea580c);
      color:#fff; border-radius:999px; font-size:11px; display:grid; place-items:center; font-weight:800; box-shadow:0 2px 6px rgba(0,0,0,.4)}

    .topbar{padding:10px 14px; display:flex; gap:10px; align-items:center}
    .search{flex:1; display:flex; gap:8px; align-items:center; background:linear-gradient(180deg,#12161c,#0f1318);
      border:1px solid var(--line); border-radius:12px; padding:10px 12px}
    .search input{flex:1; background:transparent; border:0; outline:none; color:var(--txt); font-size:14px}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0f1115;border:1px solid var(--line);
      border-radius:12px;padding:8px 10px;font-size:12px;color:var(--muted)}
    .topbar-loader{height:3px; background:linear-gradient(90deg,var(--brand),var(--brand-2)); background-size:200% 100%; animation:move 1.2s linear infinite}
    @keyframes move{0%{background-position:0 0}100%{background-position:200% 0}}

    .cats{padding:0 14px 8px 14px; display:flex; gap:8px; overflow:auto; mask-image:linear-gradient(90deg, transparent 0,#000 25px,#000 calc(100% - 25px), transparent 100%)}
    .chip{flex:0 0 auto; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#1a1f27,#14181f); color:var(--txt); font-weight:600}
    .chip.active{outline:2px solid #2f3542}

    .page{padding:8px 14px 64px}
    .cards{display:grid; grid-template-columns:1fr; gap:12px}
    .card{display:grid; grid-template-columns:86px 1fr; gap:10px; background:linear-gradient(180deg,#151921,#12161c);
      border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:var(--shadow)}
    .card .img{width:86px; height:86px; overflow:hidden; border-right:1px solid var(--line)}
    .card .img img{width:100%;height:100%;object-fit:cover;display:block; transition:transform .35s ease}
    .card:active .img img{transform:scale(1.05)}
    .card .body{padding:10px 10px 10px 0}
    .name{font-weight:800; font-size:14px}
    .desc{color:var(--muted); font-size:12px; line-height:1.25; margin:3px 0 6px}
    .price{font-weight:800;color:#fcd34d}
    .btn{appearance:none;border:0;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,#f97316,#ea580c);color:white;font-weight:800; cursor:pointer; position:relative}
    .btn.secondary{background:linear-gradient(180deg,#2b3240,#1c222c)}
    .btn.busy{opacity:.7; pointer-events:none}
    .btn .spin{width:14px;height:14px;border-radius:50%;border:2px solid #fff;border-top-color:transparent;display:inline-block;margin-right:6px;vertical-align:-2px;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .row{display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #283141}
    .empty{color:var(--muted); text-align:center; padding:14px}

    #cartDrawer{position:fixed; top:0; right:0; bottom:0; width:92vw; max-width:420px; z-index:60;
      background:linear-gradient(180deg,#161a22,#12161c); border-left:1px solid var(--line); transform:translateX(100%); transition:.28s ease; box-shadow:var(--shadow); display:flex; flex-direction:column}
    #cartDrawer.open{transform:translateX(0)}
    .drawerHead{display:flex; align-items:center; gap:8px; padding:14px; border-bottom:1px solid var(--line)}
    .drawerBody{flex:1; overflow:auto; padding:12px}
    .drawerFoot{padding:12px; border-top:1px solid var(--line); display:grid; gap:10px}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:28px;height:28px;border-radius:10px;background:#0f1115;border:1px solid var(--line);color:var(--txt); cursor:pointer}

    dialog{border:0;border-radius:16px;background:linear-gradient(180deg, #181b22, #14171d);color:var(--txt);width:min(680px,calc(100vw - 24px));box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    #mapWrap{width:min(680px,calc(100vw - 24px)); height:60vh}
    #map{width:100%; height:100%; border-radius:12px; border:1px solid var(--line)}

    .hidden{display:none !important}
    .input{width:100%;margin-top:4px;padding:12px;border-radius:12px;background:#0f1115;border:1px solid var(--line);color:var(--txt)}
    .block{background:linear-gradient(180deg,#171a20,#14161b);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--shadow)}

    .skeleton{position:relative; overflow:hidden; background:#101319; border:1px solid var(--line); border-radius:16px}
    .skeleton::after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent); transform:translateX(-100%); animation:shimmer 1.2s infinite}
    .sk-card{display:grid; grid-template-columns:86px 1fr; gap:10px; height:86px}
    .sk-img{background:#0f1115; border-right:1px solid var(--line)}
    .sk-line{height:12px; background:#0f1115; border-radius:8px; margin:8px 0}
    .sk-line.w40{width:40%} .sk-line.w60{width:60%} .sk-line.w80{width:80%}
    @keyframes shimmer{ 100% { transform:translateX(100%)}}
  </style>
</head>
<body>
  <div id="desktopBlocker" aria-hidden="true">
    <div class="box">
      <div style="font-size:42px;line-height:1;margin-bottom:8px">üì±</div>
      <h1>Abra no celular</h1>
      <p>Este aplicativo foi otimizado para dispositivos m√≥veis.</p>
    </div>
  </div>

  <div id="app">
    <header>
      <div class="wrap">
        <div class="brand" onclick="showPage('menu')">
          <img src="https://images.unsplash.com/photo-1544027993-37dbfe43562a?q=80&w=120&auto=format&fit=crop" alt="logo"/>
          <div><div class="t1">CLENA FOODS</div><div class="t2">Hamburgueria ‚Ä¢ Delivery & Retirada</div></div>
        </div>
        <div class="actions">
          <button class="iconbtn" id="btnMap" title="Localiza√ß√£o"><i class="fa-solid fa-location-dot"></i></button>
          <button class="iconbtn" id="btnCart" title="Carrinho"><i class="fa-solid fa-bag-shopping"></i><span class="badge" id="cartBadge">0</span></button>
          <button class="iconbtn" id="btnPerfil" title="Perfil"><i class="fa-solid fa-user"></i></button>
        </div>
      </div>
      <div class="topbar">
        <div class="search">
          <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8"></i>
          <input id="search" placeholder="Buscar por nome, descri√ß√£o ou ingrediente‚Ä¶" />
        </div>
        <span class="pill"><i class="fa-solid fa-motorcycle"></i>&nbsp; Entrega: Barreiras-BA</span>
      </div>
      <div id="topbarLoader" class="topbar-loader hidden"></div>
      <div class="cats" id="cats"></div>
    </header>

    <!-- P√°gina: Menu -->
    <section class="page" id="page-menu">
      <div class="cards" id="menuGrid"></div>
    </section>

    <!-- P√°gina: Complementos -->
    <section class="page hidden" id="page-complementos">
      <div class="cards" id="compsGrid"></div>
    </section>

    <!-- P√°gina: Checkout -->
    <section class="page hidden" id="page-pedidos">
      <h2>Checkout</h2>

      <!-- Status de funcionamento -->
      <div id="openBanner" class="block hidden" style="border:1px dashed #3f2f20;background:linear-gradient(180deg,#1b150f,#13100d)">
        <strong id="openTitle">Funcionamento</strong>
        <div id="openMsg" style="color:#d6c3a4;margin-top:4px"></div>
      </div>

      <div class="grid2" style="margin-top:8px">
        <label>
          <div>Forma de Entrega</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button data-entrega="delivery" class="btn secondary" onclick="setEntrega(this)">Entrega</button>
            <button data-entrega="pickup" class="btn secondary" onclick="setEntrega(this)">Retirada</button>
          </div>
        </label>
        <label>
          <div>Pagamento</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button data-pay="credito" class="btn secondary" onclick="selPay(this)">Cr√©dito</button>
            <button data-pay="debito" class="btn secondary" onclick="selPay(this)">D√©bito</button>
            <button data-pay="dinheiro" class="btn secondary" onclick="selPay(this)">Dinheiro</button>
            <button data-pay="pix" class="btn secondary" onclick="selPay(this)">PIX</button>
          </div>
        </label>
      </div>

      <!-- Sele√ß√£o de endere√ßo -->
      <div id="addrSelectBox" class="block hidden" style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:end;flex-wrap:wrap">
          <label style="flex:1">
            <div>Endere√ßo para entrega</div>
            <select id="addrSelect" class="input"></select>
          </label>
          <button class="btn secondary" id="btnNewAddr"><i class="fa-solid fa-plus"></i> Novo endere√ßo</button>
        </div>
      </div>

      <!-- Form novo endere√ßo (checkout) -->
      <div id="addrForm" class="block hidden" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Novo endere√ßo</h3>
        <div class="grid2">
          <label>Apelido <input id="f-apelido" class="input" placeholder="Casa, Trabalho‚Ä¶"/></label>
          <div>
            <div>CEP</div>
            <div style="display:flex;gap:8px">
              <input id="f-cep" placeholder="00000-000" class="input" style="flex:1"/>
              <button class="btn secondary" id="btnCepCheckout"><i class="fa-solid fa-magnifying-glass-location"></i> Buscar CEP</button>
            </div>
          </div>
          <label>Cidade <input id="f-cidade" placeholder="Cidade" class="input"/></label>
          <label>Bairro <input id="f-bairro" placeholder="Bairro" class="input"/></label>
          <label>Rua/Avenida <input id="f-rua" placeholder="Logradouro" class="input"/></label>
          <label>N√∫mero <input id="f-num" placeholder="N¬∫" class="input"/></label>
          <label class="grid2" style="grid-column:1/-1">Complemento <input id="f-comp" placeholder="Apto/Bloco/Ponto de ref." class="input"/></label>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="btnSaveAddr"><i class="fa-solid fa-floppy-disk"></i> Salvar e usar</button>
          <button class="btn secondary" id="btnCancelAddr"><i class="fa-solid fa-xmark"></i> Cancelar</button>
        </div>
      </div>

      <!-- PIX -->
      <div id="pixBox" class="hidden" style="margin-top:12px;border:1px dashed #334155;padding:12px;border-radius:12px">
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
          <canvas id="pixQr" width="160" height="160" style="background:#0f1115;border-radius:8px;border:1px solid var(--line)"></canvas>
          <div style="flex:1;min-width:240px">
            <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
              <strong>PIX ‚Äì Copia e Cola</strong>
              <button class="btn secondary" onclick="copyPix()"><i class="fa-regular fa-copy"></i> Copiar</button>
            </div>
            <textarea id="pixCop" rows="3" style="width:100%;margin-top:8px;background:#0f1115;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:8px" readonly></textarea>
            <small style="color:var(--muted)">Ap√≥s o pagamento, seu pedido √© confirmado automaticamente.</small>
          </div>
        </div>
      </div>

      <!-- Resumo -->
      <div id="checkoutList" style="margin-top:8px"></div>
      <div class="row"><span>Entrega</span><strong id="shipTax">‚Äî</strong></div>
      <div class="row" style="border-top:1px dashed #334155"><span>Total</span><strong id="checkoutTotal">R$ 0,00</strong></div>

      <button class="btn" id="btnFinish" style="margin-top:12px" onclick="finishOrder()" disabled>
        <i class="fa-solid fa-paper-plane"></i> Confirmar Pedido
      </button>
    </section>

    <!-- P√°gina: Perfil -->
    <section class="page hidden" id="page-perfil">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 style="margin:0">Minha Conta</h2>
        <button class="btn secondary" onclick="closePerfil()"><i class="fa-solid fa-xmark"></i> Fechar</button>
      </div>

      <!-- Login -->
      <form id="loginBox" class="block" style="margin-top:12px">
        <h3>Entrar</h3>
        <label>WhatsApp <input id="pwa" class="input" placeholder="(77) 9 0000-0000"/></label>
        <label>Senha <input id="ppw" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></label>
        <button type="button" class="btn" onclick="login()" id="btnLogin"><i class="fa-solid fa-right-to-bracket"></i> Entrar</button>
        <p style="color:var(--muted);font-size:13px">N√£o tem cadastro? Role para criar.</p>
      </form>

      <!-- Cadastro (+ endere√ßo padr√£o opcional) -->
      <form id="signupBox" class="block" style="margin-top:12px">
        <h3>Criar conta</h3>
        <div class="grid2">
          <label>Nome completo <input id="s-nome" class="input"/></label>
          <label>WhatsApp <input id="s-wa" class="input" placeholder="(77) 9 0000-0000"/></label>
          <label>E-mail <input id="s-mail" class="input"/></label>
          <label>Senha <input id="s-senha" type="password" class="input"/></label>
        </div>

        <div class="block" style="margin-top:12px">
          <h4 style="margin:0 0 6px">Endere√ßo (opcional)</h4>
          <div class="grid2">
            <label>Apelido <input id="sa-apelido" class="input" placeholder="Casa/Trabalho"/></label>
            <div>
              <div>CEP</div>
              <div style="display:flex;gap:8px">
                <input id="sa-cep" class="input" placeholder="00000-000" style="flex:1"/>
                <button class="btn secondary" type="button" id="btnCepSignup"><i class="fa-solid fa-magnifying-glass-location"></i> Buscar CEP</button>
              </div>
            </div>
            <label>Cidade <input id="sa-cidade" class="input"/></label>
            <label>Bairro <input id="sa-bairro" class="input"/></label>
            <label>Rua/Avenida <input id="sa-rua" class="input"/></label>
            <label>N√∫mero <input id="sa-num" class="input"/></label>
            <label class="grid2" style="grid-column:1/-1">Complemento <input id="sa-comp" class="input"/></label>
          </div>
        </div>

        <button type="button" class="btn" onclick="signup()" id="btnSignup"><i class="fa-solid fa-user-plus"></i> Cadastrar</button>
      </form>

      <!-- Hist√≥rico -->
      <div id="profileBox" class="hidden" style="margin-top:16px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:48px;height:48px;border-radius:50%;background:#0f1115;border:1px solid var(--line);display:grid;place-items:center"><i class="fa-solid fa-user"></i></div>
          <div><div id="uNome" style="font-weight:800"></div><div id="uWa" style="color:var(--muted);font-size:13px"></div></div>
          <div style="margin-left:auto"><button class="btn secondary" onclick="logout()">Sair</button></div>
        </div>

        <div class="block" style="margin-top:12px">
          <h3 style="margin:0 0 8px"><i class="fa-solid fa-clock-rotate-left"></i> Meus Pedidos</h3>
          <div id="ordersList" style="display:grid;gap:8px"></div>
        </div>
      </div>
    </section>

    <nav class="tabbar">
      <button data-page="menu" class="active"><i class="fa-solid fa-burger"></i><span>Card√°pio</span></button>
      <button data-page="complementos"><i class="fa-solid fa-plus"></i><span>Extras</span></button>
      <button data-page="pedidos"><i class="fa-solid fa-receipt"></i><span>Pedidos</span></button>
      <button data-page="perfil"><i class="fa-solid fa-user"></i><span>Perfil</span></button>
    </nav>

    <dialog id="dlgItem"><div id="itemBox"></div></dialog>

    <dialog id="dlgMap">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
        <strong><i class="fa-solid fa-location-dot"></i> Localiza√ß√£o & Rota</strong>
        <button class="btn secondary" onclick="dlgMap.close()"><i class="fa-solid fa-xmark"></i> Fechar</button>
      </div>
      <div id="mapWrap"><div id="map"></div></div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <span class="pill"><i class="fa-solid fa-store"></i> Loja: Rua Pernambuco, 629 ‚Äî Vila Brasil, Barreiras-BA</span>
        <span class="pill" id="mapStatus">üìç Toque em ‚ÄúVer rota‚Äù</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="btnUseLoc"><i class="fa-solid fa-person-walking"></i> Ver rota</button>
        <button class="btn secondary" id="btnClearRoute"><i class="fa-solid fa-route"></i> Remover rota</button>
      </div>
    </dialog>
  </div>

  <aside id="cartDrawer" aria-hidden="true">
    <div class="drawerHead"><button class="iconbtn" onclick="toggleCart(false)"><i class="fa-solid fa-chevron-right"></i></button><strong style="font-size:16px">Meu Carrinho</strong></div>
    <div class="drawerBody" id="cartItems"></div>
    <div class="drawerFoot">
      <div class="row"><span>Subtotal</span><strong id="subTotal">R$ 0,00</strong></div>
      <div class="row"><span>Entrega</span><strong id="shipTaxDrawer">‚Äî</strong></div>
      <div class="row" style="border-top:1px dashed #334155; padding-top:8px"><span>Total</span><strong id="grandTotal">R$ 0,00</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn secondary" style="flex:1" onclick="clearCart()"><i class="fa-solid fa-trash"></i> Limpar</button>
        <button class="btn" style="flex:2" onclick="goCheckout()"><i class="fa-solid fa-credit-card"></i> Finalizar</button>
      </div>
    </div>
  </aside>

  <script>
  (function enforceMobileOnly(){
    const isUA=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isSmall=Math.min(window.innerWidth,window.innerHeight)<768;
    const allow=isUA&&isSmall;
    document.getElementById('desktopBlocker').style.display=allow?'none':'flex';
    const app=document.getElementById('app'); if(app) app.style.display=allow?'':'none';
    let to=null; const rerun=()=>{clearTimeout(to); to=setTimeout(enforceMobileOnly,150)};
    window.addEventListener('resize',rerun); window.addEventListener('orientationchange',rerun);
  })();

  // ===== CONFIG =====
  const API_URL = 'https://script.google.com/macros/s/AKfycbyuxfyXM7XgYMa_VPJiBkwM4nHagNjVP6U4pblZh9uxjpDpdVB_-j1bT7Uw9vLeUF4Z/exec'; // <-- troque
  const PIX_CHAVE = '08338807567';
  const PIX_RECEPTOR = 'CLENA FOODS';
  const PIX_CIDADE = 'BARREIRAS-BA';
  const STORE_LAT = -12.139814, STORE_LNG = -44.9893035;

  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const BRL = v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const digitsOnly = s => String(s||'').replace(/\D/g,'');
  const normalize = s => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  const store = { get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))}, del(k){localStorage.removeItem(k)} };

  let user = store.get('cf_user', null);
  let token = store.get('cf_token', null);
  let cart = store.get('cf_cart', []);
  let entrega = 'delivery', payMethod='credito';
  let savedAddr = null;
  let menu=[], complements=[];
  let activeCat=null;
  let fees = [];               // taxas por bairro
  let addresses = [];          // endere√ßos do usu√°rio
  let selectedAddressId=null;  // endere√ßo escolhido
  let shipFee = 0;
  let isOpen = true;           // status de funcionamento
  const pages=['menu','complementos','pedidos','perfil'];

  // ===== UI helpers
  function showTopbarLoader(b){ $('#topbarLoader').classList.toggle('hidden', !b); }
  function setBtnBusy(btn, busy=true, label='Aguarde‚Ä¶'){
    if(!btn) return; if(busy){ btn.dataset.prev=btn.innerHTML; btn.classList.add('busy'); btn.innerHTML=`<span class="spin"></span>${label}`; btn.disabled=true; }
    else{ btn.classList.remove('busy'); btn.innerHTML=btn.dataset.prev||btn.innerHTML; btn.disabled=false; }
  }

  // ===== Navega√ß√£o
  $$('.tabbar [data-page]').forEach(btn=>{
    btn.onclick=()=>{$$('.tabbar button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); showPage(btn.dataset.page); if(btn.dataset.page!=='perfil') toggleCart(false); };
  });
  $('#btnCart').onclick=()=>toggleCart(true);
  $('#btnPerfil').onclick=()=>{ setActiveTab('perfil'); showPage('perfil'); };
  $('#btnMap').onclick=openMapDialog;
  function setActiveTab(p){ $$('.tabbar button').forEach(b=>b.classList.toggle('active', b.dataset.page===p)); }
  function toggleCart(open){ const dr=$('#cartDrawer'); dr.classList.toggle('open',open); dr.setAttribute('aria-hidden', open?'false':'true'); }

  // ===== Busca
  let searchTO=null;
  $('#search').addEventListener('input',()=>{ clearTimeout(searchTO); searchTO=setTimeout(()=>renderMenu(activeCat),120) });

  // ===== API
  async function api(acao, payload={}){
    try{
      showTopbarLoader(true);
      const res = await fetch(API_URL,{method:'POST', body: JSON.stringify({acao,token,...payload})});
      const text = await res.text(); let data;
      try{ data=JSON.parse(text) }catch(e){ throw new Error(`Resposta n√£o-JSON (HTTP ${res.status})`) }
      if(!res.ok || data.ok===false) throw new Error(data.error||`HTTP ${res.status}`);
      return data;
    }catch(e){ alert(`Erro na API (${acao}): ${e.message}`); return {ok:false, error:e.message} }
    finally{ showTopbarLoader(false) }
  }

  // ===== Boot
  (async function init(){
    menuSkeleton();
    await Promise.all([loadMenu(), loadComplements(), fetchFees(), fetchOpenStatus()]);
    if(user){ applyUser(); await Promise.all([fetchOrders(), fetchAddresses()]); }
    renderCart(); updateAuthUI();
    setupNotifications();

    // eventos CEP
    $('#btnCepSignup').onclick = ()=>cepLookup($('#sa-cep').value, {cidade:'#sa-cidade', bairro:'#sa-bairro', rua:'#sa-rua'});
    $('#btnCepCheckout').onclick = ()=>cepLookup($('#f-cep').value, {cidade:'#f-cidade', bairro:'#f-bairro', rua:'#f-rua'});
    $('#btnNewAddr').onclick = ()=>{ $('#addrForm').classList.remove('hidden'); };
    $('#btnCancelAddr').onclick = ()=>{ $('#addrForm').classList.add('hidden'); };
    $('#btnSaveAddr').onclick = saveNewAddress;
    $('#addrSelect').onchange = ()=>{ selectedAddressId = $('#addrSelect').value || null; fillAddrFormFromSelect(false); calcShipping(); renderTotals(); };
  })();

  // ===== Dados iniciais
  function menuSkeleton(n=6){
    const grid=$('#menuGrid'); grid.innerHTML='';
    for(let i=0;i<n;i++){
      const sk=document.createElement('div'); sk.className='skeleton sk-card';
      sk.innerHTML=`<div class="sk-img"></div><div style="padding:10px 10px 10px 0"><div class="sk-line w80"></div><div class="sk-line w60"></div><div class="sk-line w40"></div></div>`;
      grid.appendChild(sk);
    }
  }
  async function loadMenu(){ const d=await api('getMenu'); menu=d.ok?d.items:[]; renderCategories(); renderMenu(); }
  async function loadComplements(){ const d=await api('getComplements'); complements=d.ok?d.items:[]; const grid=$('#compsGrid'); grid.innerHTML=''; (complements.length?complements:[]).forEach(c=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="img skeleton"></div><div class="body"><div class="name">${c.name}</div><div class="desc">${c.tag||''}</div><div class="price">${BRL(c.price||0)}</div></div>`; grid.appendChild(el); }); }
  async function fetchFees(){ const r=await api('getFees'); fees = r.ok ? r.items : []; }
  async function fetchOpenStatus(){ const r=await api('getOpenStatus'); isOpen = !!(r.ok && r.open); const banner=$('#openBanner'); const msg=$('#openMsg'); const title=$('#openTitle'); if(r.ok){ if(r.open){ banner.classList.remove('hidden'); title.textContent='Estamos abertos ‚úÖ'; msg.textContent = r.message || 'Fa√ßa seu pedido normalmente.'; }else{ banner.classList.remove('hidden'); title.textContent='Estamos fechados ‚õî'; msg.textContent = r.message || 'Voltamos em breve.'; } } }

  // ===== Categorias / Menu
  function renderCategories(){ const cats=['Tudo', ...new Set(menu.map(i=>i.cat))]; const box=$('#cats'); box.innerHTML=''; cats.forEach((c,ix)=>{ const chip=document.createElement('button'); chip.className='chip'+(ix===0?' active':''); chip.textContent=c; chip.onclick=()=>{ $$('#cats .chip').forEach(x=>x.classList.remove('active')); chip.classList.add('active'); activeCat=(c==='Tudo'?null:c); renderMenu(activeCat); }; box.appendChild(chip); }); }
  function renderMenu(cat){ const q=normalize($('#search').value); const grid=$('#menuGrid'); grid.innerHTML=''; (menu||[]).filter(i=>(!cat || i.cat===cat)).filter(i=> (normalize(i.name)+' '+normalize(i.desc||'')+' '+normalize(i.cat)).includes(q)).forEach(i=>grid.appendChild(cardItem(i))); }
  function cardItem(i){ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="img"><img src="${i.img}" alt="${i.name}" loading="lazy"></div><div class="body"><div class="name">${i.name}</div><div class="desc">${i.desc||''}</div><div style="display:flex;align-items:center;justify-content:space-between"><div class="price">${BRL(i.price)}</div><button class="btn">Adicionar</button></div></div>`; el.querySelector('.btn').onclick=()=>requireLoginThen(()=>openItem(i)); return el; }

  function requireLoginThen(action){ if(!user){ alert('Voc√™ precisa estar logado para adicionar itens.'); setActiveTab('perfil'); showPage('perfil'); return; } action(); }
  function openItem(i){
    const compHtml=(complements||[]).map(c=>`<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-compid="${c.id}" data-compprice="${c.price}"/> ${c.name} <span style="margin-left:auto">${BRL(c.price)}</span></label>`).join('');
    $('#itemBox').innerHTML=`<div class="grid2" style="gap:16px"><div><img src="${i.img}" alt="${i.name}" style="width:100%;border-radius:12px;border:1px solid var(--line)"/></div><div><h3 style="margin:0">${i.name}</h3><p style="color:var(--muted)">${i.desc||''}</p><div class="pill" style="margin:8px 0">Pre√ßo base <strong>${BRL(i.price)}</strong></div><h4>Complementos</h4><div style="display:grid;gap:6px;max-height:180px;overflow:auto;padding-right:6px">${compHtml||'<em style="color:var(--muted)">Nenhum complemento cadastrado</em>'}</div><div style="display:flex;gap:8px;margin-top:10px;align-items:center"><button class="btn" id="addBtn">Adicionar ao carrinho</button><button class="btn secondary" onclick="dlgItem.close()">Cancelar</button></div></div></div>`;
    $('#addBtn').onclick=()=>{ const chec=Array.from($('#dlgItem').querySelectorAll('input[type=checkbox]:checked')).map(ch=>({id:ch.dataset.compid, name:(complements.find(c=>c.id===ch.dataset.compid)||{}).name||'Extra', price:Number(ch.dataset.compprice)})); addToCart({id:i.id,name:i.name,price:Number(i.price),qty:1,img:i.img,comps:chec}); dlgItem.close(); toggleCart(true); };
    dlgItem.showModal();
  }

  // ===== Carrinho
  function addToCart(item){ if(!user){ alert('Fa√ßa login para adicionar itens.'); setActiveTab('perfil'); showPage('perfil'); return; } const k=JSON.stringify({id:item.id, comps:item.comps.map(c=>c.id).sort()}); const found=cart.find(x=>JSON.stringify({id:x.id, comps:(x.comps||[]).map(c=>c.id).sort()})===k); if(found){ found.qty++ } else { cart.push(item) } store.set('cf_cart',cart); renderCart(); }
  function inc(i){ cart[i].qty++; store.set('cf_cart',cart); renderCart() }
  function dec(i){ cart[i].qty>1?cart[i].qty--:cart.splice(i,1); store.set('cf_cart',cart); renderCart() }
  function clearCart(){ if(!cart.length) return; if(confirm('Tem certeza que deseja limpar o carrinho?')){ cart=[]; store.set('cf_cart',cart); renderCart(); } }
  function renderCart(){
    const count=cart.reduce((a,b)=>a+b.qty,0); $('#cartBadge').textContent=count;
    const box=$('#cartItems'); box.innerHTML='';
    if(!cart.length){ box.innerHTML='<div class="empty">Seu carrinho est√° vazio.</div>'; }
    else{
      cart.forEach((it,ix)=>{
        const extras=it.comps?.length? `<div style="color:var(--muted);font-size:12px">+ ${it.comps.map(c=>c.name).join(', ')}</div>`:'';
        const total=(it.price+(it.comps||[]).reduce((a,b)=>a+Number(b.price||0),0))*it.qty;
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div style="max-width:58%"><div style="font-weight:600">${it.name}</div>${extras}</div><div class="qty"><button onclick="dec(${ix})">-</button><span>${it.qty}</span><button onclick="inc(${ix})">+</button><strong style="width:86px;text-align:right">${BRL(total)}</strong></div>`;
        box.appendChild(row);
      });
    }
    const sub = cart.reduce((a,it)=>a+(it.price+(it.comps||[]).reduce((x,y)=>x+Number(y.price||0),0))*it.qty,0);
    $('#subTotal').textContent=BRL(sub);
    calcShipping();
    renderTotals();
  }
  function goCheckout(){ setActiveTab('pedidos'); showPage('pedidos'); toggleCart(false); window.scrollTo({top:0,behavior:'smooth'}); if(user) fetchAddresses(); }

  // ===== Entrega / Pagamento
  function setEntrega(btnOrMode){
    const mode=typeof btnOrMode==='string'?btnOrMode:btnOrMode.dataset.entrega; entrega=mode;
    $$('#page-pedidos [data-entrega]').forEach(b=>b.classList.remove('active'));
    const match=$$('#page-pedidos [data-entrega]').find(b=>b.dataset.entrega===mode); if(match) match.classList.add('active');
    $('#addrSelectBox').classList.toggle('hidden', entrega!=='delivery');
    $('#addrForm').classList.add('hidden'); // esconde o formul√°rio at√© pedir novo
    renderCart();
  }
  function selPay(btn){ $$('#page-pedidos [data-pay]').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); payMethod=btn.dataset.pay; $('#pixBox').classList.toggle('hidden', payMethod!=='pix'); if(payMethod==='pix') createPix(); }
  function renderCheckout(){
    const box=$('#checkoutList'); box.innerHTML=''; let total=0;
    cart.forEach(it=>{ const extras=it.comps?.length?` (+${it.comps.map(c=>c.name).join(', ')})`:''; const t=(it.price+(it.comps||[]).reduce((a,b)=>a+Number(b.price||0),0))*it.qty; total+=t; const row=document.createElement('div'); row.className='row'; row.innerHTML=`<span>${it.qty}√ó ${it.name}${extras}</span><strong>${BRL(t)}</strong>`; box.appendChild(row); });
  }
  function renderTotals(){
    renderCheckout();
    $('#shipTax').textContent = entrega==='delivery' ? (shipFee>0?BRL(shipFee): (selectedAddressId?'R$ 0,00':'‚Äî selecione')) : 'R$ 0,00';
    $('#shipTaxDrawer').textContent = $('#shipTax').textContent;
    const sub = cart.reduce((a,it)=>a+(it.price+(it.comps||[]).reduce((x,y)=>x+Number(y.price||0),0))*it.qty,0);
    const total = sub + (entrega==='delivery' ? Number(shipFee||0) : 0);
    $('#grandTotal').textContent = BRL(total);
    $('#checkoutTotal').textContent = BRL(total);
  }

  // ===== Endere√ßos
  async function fetchAddresses(){
    const r = await api('listAddresses');
    if(r.ok){ addresses=r.items||[]; fillAddressSelect(); }
  }
  function fillAddressSelect(){
    const sel=$('#addrSelect'); sel.innerHTML='';
    if(!addresses.length){ sel.innerHTML='<option value="">Nenhum endere√ßo salvo</option>'; selectedAddressId=null; $('#addrForm').classList.remove('hidden'); }
    else{
      addresses.forEach(a=>{ const opt=document.createElement('option'); opt.value=a.id; opt.textContent=(a.apelido? a.apelido+' ‚Äî ' : '') + `${a.rua}, ${a.num} ‚Ä¢ ${a.bairro}`; sel.appendChild(opt); });
      if(!selectedAddressId) selectedAddressId = addresses[0].id;
      sel.value = selectedAddressId;
      fillAddrFormFromSelect(false);
    }
    calcShipping(); renderTotals();
  }
  function fillAddrFormFromSelect(showForm){
    const a = addresses.find(x=>x.id===selectedAddressId);
    if(!a) return;
    if(showForm) $('#addrForm').classList.remove('hidden');
    $('#f-apelido').value=a.apelido||'';
    $('#f-cep').value=a.cep||'';
    $('#f-cidade').value=a.cidade||'';
    $('#f-bairro').value=a.bairro||'';
    $('#f-rua').value=a.rua||'';
    $('#f-num').value=a.num||'';
    $('#f-comp').value=a.comp||'';
  }
  async function saveNewAddress(){
    if(!user) return alert('Fa√ßa login.');
    const req=[['f-cep','CEP'],['f-cidade','Cidade'],['f-bairro','Bairro'],['f-rua','Rua'],['f-num','N√∫mero']];
    for(const [id,label] of req){ if(!$('#'+id).value.trim()) return alert('Preencha: '+label); }
    const addr={ apelido:$('#f-apelido').value.trim(), cep:$('#f-cep').value.trim(), cidade:$('#f-cidade').value.trim(), bairro:$('#f-bairro').value.trim(), rua:$('#f-rua').value.trim(), num:$('#f-num').value.trim(), comp:$('#f-comp').value.trim() };
    const btn=$('#btnSaveAddr'); setBtnBusy(btn,true,'Salvando‚Ä¶');
    const r = await api('addAddress',{addr});
    setBtnBusy(btn,false);
    if(r.ok){ $('#addrForm').classList.add('hidden'); await fetchAddresses(); selectedAddressId=r.addr.id; fillAddressSelect(); calcShipping(); renderTotals(); }
    else alert('Erro ao salvar endere√ßo: '+(r.error||''));
  }

  // ViaCEP
  async function cepLookup(cep, map){
    cep = digitsOnly(cep);
    if(cep.length!==8){ alert('CEP inv√°lido'); return; }
    try{
      const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
      const j = await r.json();
      if(j.erro){ alert('CEP n√£o encontrado'); return; }
      if(map.cidade) $(map.cidade).value = `${j.localidade||''}-${j.uf||''}`;
      if(map.bairro) $(map.bairro).value = j.bairro||'';
      if(map.rua)    $(map.rua).value    = j.logradouro||'';
    }catch{ alert('Falha ao consultar CEP'); }
  }

  // ===== Frete
  function calcShipping(){
    shipFee = 0;
    if(entrega!=='delivery') return;
    const addr = addresses.find(x=>x.id===selectedAddressId);
    if(!addr){ $('#shipTax').textContent='‚Äî selecione'; $('#shipTaxDrawer').textContent='‚Äî selecione'; return; }
    const bnorm = normalize(addr.bairro);
    const match = fees.find(f=>normalize(f.bairro)===bnorm || normalize(f.bairro).includes(bnorm) || bnorm.includes(normalize(f.bairro)));
    shipFee = match ? Number(match.taxa||0) : 0;
  }

  // ===== Login / Cadastro
  function updateAuthUI(){ $('#btnFinish').disabled = !user || !isOpen; }
  function applyUser(){ $('#loginBox').classList.add('hidden'); $('#signupBox').classList.add('hidden'); $('#profileBox').classList.remove('hidden'); $('#uNome').textContent=user?.nome||'Cliente'; $('#uWa').textContent=user?.whatsapp||''; updateAuthUI(); }

  async function login(){
    const btn=$('#btnLogin'); setBtnBusy(btn,true,'Entrando‚Ä¶');
    const whatsapp=digitsOnly($('#pwa').value); const senha=$('#ppw').value.trim();
    const r=await api('login',{whatsapp,senha,ua:navigator.userAgent});
    setBtnBusy(btn,false);
    if(r.ok){ user=r.user; token=r.token; store.set('cf_user',user); store.set('cf_token',token); applyUser(); fetchOrders(); fetchAddresses(); startPolling(); alert('Bem-vindo!'); }
    else alert('Falha no login: '+(r.error||''));
  }

  async function signup(){
    const btn=$('#btnSignup'); setBtnBusy(btn,true,'Cadastrando‚Ä¶');
    const payload={ nome:$('#s-nome').value.trim(), whatsapp:digitsOnly($('#s-wa').value), email:$('#s-mail').value.trim(), senha:$('#s-senha').value.trim(),
      address:{ apelido:$('#sa-apelido').value.trim(), cep:$('#sa-cep').value.trim(), cidade:$('#sa-cidade').value.trim(), bairro:$('#sa-bairro').value.trim(), rua:$('#sa-rua').value.trim(), num:$('#sa-num').value.trim(), comp:$('#sa-comp').value.trim() } };
    const r=await api('signup',payload);
    setBtnBusy(btn,false);
    if(r.ok){ alert('Cadastro realizado! Fa√ßa o login.'); setActiveTab('perfil'); showPage('perfil'); }
    else alert('Erro no cadastro: '+(r.error||''));
  }
  function logout(){ user=null; token=null; store.del('cf_user'); store.del('cf_token'); location.reload(); }

  // ===== Pedido
  async function finishOrder(){
    if(!user){ setActiveTab('perfil'); showPage('perfil'); alert('Voc√™ precisa estar logado.'); return }
    if(!isOpen){ alert('Estamos fechados agora.'); return }
    if(!cart.length){ alert('Seu carrinho est√° vazio.'); return; }

    let endereco=null, endereco_id=null;
    if(entrega==='delivery'){
      if(selectedAddressId){ endereco_id=selectedAddressId; endereco = addresses.find(x=>x.id===selectedAddressId)||null; }
      else{
        const req=[['f-cep','CEP'],['f-cidade','Cidade'],['f-bairro','Bairro'],['f-rua','Rua/Avenida'],['f-num','N√∫mero']];
        for(const [id,label] of req){ if(!$('#'+id).value.trim()) return alert('Preencha: '+label); }
        endereco={ apelido:$('#f-apelido').value, cep:$('#f-cep').value, cidade:$('#f-cidade').value, bairro:$('#f-bairro').value, rua:$('#f-rua').value, num:$('#f-num').value, comp:$('#f-comp').value };
      }
    }

    const order={ entrega, pay:payMethod, endereco, endereco_id, ship_fee:shipFee,
      items:cart, total: cart.reduce((a,it)=> a+(it.price+(it.comps||[]).reduce((x,y)=>x+Number(y.price||0),0))*it.qty,0) + (entrega==='delivery'?Number(shipFee||0):0) };

    const btn=$('#btnFinish'); setBtnBusy(btn,true,'Enviando‚Ä¶');
    const r=await api('createOrder',{order});
    setBtnBusy(btn,false);
    if(!r.ok) return;
    cart=[]; store.set('cf_cart',cart); renderCart();
    alert('Pedido enviado! C√≥digo: '+r.id);
    setActiveTab('perfil'); showPage('perfil'); fetchOrders();
  }

  // ===== Pedidos do usu√°rio
  async function fetchOrders(){
    if(!user) return;
    const box=$('#ordersList'); box.innerHTML=''; for(let i=0;i<3;i++){ const sk=document.createElement('div'); sk.className='skeleton'; sk.style.height='56px'; sk.style.margin='6px 0'; box.appendChild(sk); }
    const r=await api('listOrders'); box.innerHTML='';
    if(r.ok && r.items?.length){
      r.items.forEach(o=>{ const li=document.createElement('div'); li.className='block';
        li.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
          <div><strong>Pedido #${o.id}</strong><div style="color:var(--muted);font-size:12px">${new Date(o.created_at).toLocaleString()}</div></div>
          <span class="pill">Pagamento: <strong>${o.status_pagamento||'Pendente'}</strong></span>
          <span class="pill">Andamento: <strong>${o.status_pedido||'Recebido'}</strong></span>
          <span class="pill">Total: <strong>${BRL(o.total||0)}</strong></span></div>`;
        box.appendChild(li); });
    } else { box.innerHTML='<div class="empty">Voc√™ ainda n√£o possui pedidos.</div>'; }
  }

  function showPage(id){ pages.forEach(p=> document.getElementById('page-'+p)?.classList.toggle('hidden', p!==id)); window.scrollTo(0,0); }
  function closePerfil(){ setActiveTab('menu'); showPage('menu'); }

  // ===== Mapa
  let map, storeMarker, userMarker, routing, mapReady=false;
  function openMapDialog(){
    dlgMap.showModal();
    setTimeout(()=>{ 
      if(!mapReady){
        map=L.map('map',{zoomControl:false}).setView([STORE_LAT,STORE_LNG],16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
        storeMarker=L.marker([STORE_LAT,STORE_LNG]).addTo(map).bindPopup('Clena Foods ‚Äî Rua Pernambuco, 629');
        mapReady=true;
      }else{ map.invalidateSize(); map.setView([STORE_LAT,STORE_LNG],16); }
      $('#mapStatus').textContent='üìç Loja fixa ‚Äî Rua Pernambuco, 629';
    },50);
  }
  $('#btnUseLoc').onclick=()=>{ if(!navigator.geolocation){ $('#mapStatus').textContent='‚ÑπÔ∏è Geolocaliza√ß√£o indispon√≠vel'; return }
    $('#mapStatus').textContent='‚è≥ Solicitando sua localiza√ß√£o‚Ä¶';
    navigator.geolocation.getCurrentPosition((pos)=>{ const {latitude,longitude}=pos.coords; if(userMarker) userMarker.remove(); userMarker=L.marker([latitude,longitude]).addTo(map).bindPopup('Voc√™'); map.setView([latitude,longitude],14); $('#mapStatus').textContent='‚úÖ Localiza√ß√£o ativa ‚Ä¢ Rota tra√ßada'; if(routing) routing.remove(); routing=L.Routing.control({waypoints:[L.latLng(latitude,longitude),L.latLng(STORE_LAT,STORE_LNG)],fitSelectedRoutes:true,addWaypoints:false,collapsible:true,show:false,routeWhileDragging:false}).addTo(map); }, ()=> $('#mapStatus').textContent='‚ö†Ô∏è Permiss√£o negada'); };
  $('#btnClearRoute').onclick=()=>{ if(routing){routing.remove(); routing=null} if(userMarker){userMarker.remove(); userMarker=null} map.setView([STORE_LAT,STORE_LNG],16); $('#mapStatus').textContent='üìç Loja fixa ‚Ä¢ Rota removida'; };

  // ===== PIX
  function emv(id,val){const len=String(val.length).padStart(2,'0'); return id+len+val}
  function pixPayload({nome,cidade,chave,valor,txid='CF'+Date.now().toString().slice(-8)}){
    const method=emv('00','BR.GOV.BCB.PIX')+(chave?emv('01',chave):''); const mer=emv('26',method); const cat=emv('52','0000'); const curr=emv('53','986');
    const amount=valor?emv('54',String(Number(valor).toFixed(2))):''; const ctry=emv('58','BR'); const city=emv('60',(cidade||'BRASILIA').substring(0,15).toUpperCase());
    const name=emv('59',(nome||'RECEBEDOR').substring(0,25).toUpperCase()); const add=emv('62',emv('05',txid.substring(0,25)));
    let body=emv('00','01')+emv('01','12')+mer+cat+curr+amount+ctry+name+city+add+'6304'; const crc=crc16(body).toUpperCase(); return body+crc;
  }
  function crc16(str){let crc=0xFFFF; for(let i=0;i<str.length;i++){crc^=str.charCodeAt(i)<<8; for(let j=0;j<8;j++) crc=(crc&0x8000)?(crc<<1)^0x1021:(crc<<1); crc&=0xFFFF;} return crc.toString(16).padStart(4,'0');}
  function createPix(){ const total=cart.reduce((a,it)=> a+(it.price+(it.comps||[]).reduce((x,y)=>x+Number(y.price||0),0))*it.qty,0)+(entrega==='delivery'?Number(shipFee||0):0); const payload=pixPayload({nome:PIX_RECEPTOR,cidade:PIX_CIDADE,chave:PIX_CHAVE,valor:total}); const ta=$('#pixCop'); if(ta) ta.value=payload; const cv=$('#pixQr'); if(cv) new QRious({element:cv,value:payload,size:160}); }
  function copyPix(){ const ta=$('#pixCop'); ta.select(); document.execCommand('copy'); alert('C√≥digo PIX copiado!'); }

  // ===== Notifica√ß√µes
  let notifSince=Number(store.get('cf_notif_since', Date.now()-3600*1000)), pollTimer=null;
  function setupNotifications(){ if('Notification' in window && Notification.permission==='default'){ setTimeout(()=>Notification.requestPermission().catch(()=>{}),800); } startPolling(); }
  function startPolling(){ if(pollTimer) clearTimeout(pollTimer); const loop=async()=>{ try{ if(!user){pollTimer=setTimeout(loop,10000); return} const r=await api('pollNotifications',{since:notifSince}); if(r.ok&&Array.isArray(r.items)){ r.items.forEach(showNotification); const maxTs=r.items.reduce((m,it)=>Math.max(m, it.created_at||0), notifSince); if(maxTs>notifSince){ notifSince=maxTs; store.set('cf_notif_since',notifSince); } } }catch{} pollTimer=setTimeout(loop,10000)}; loop(); }
  function showNotification(n){ const title=n.title||'Atualiza√ß√£o do pedido'; const body=n.message||''; if('Notification' in window && Notification.permission==='granted'){ const note=new Notification(title,{body}); note.onclick=()=>{window.focus(); setActiveTab('perfil'); showPage('perfil');}; } else { alert(`${title}\n\n${body}`); } if(n.order_id) fetchOrders(); }
  </script>
</body>
</html>
