<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Clena Foods ‚Ä¢ Card√°pio & Pedidos</title>
  <meta name="description" content="Cat√°logo de produtos, complementos e pedidos com login por WhatsApp + senha, PIX e notifica√ß√µes." />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0e0f12">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <!-- √çcones e fontes -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0e0f12; --panel:#14161a; --soft:#1a1f27; --line:#262b36;
      --brand:#e63946; --brand-2:#ff8f1f; --txt:#f7f8fa; --muted:#cbd5e1;
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter, sans-serif;}
    header{position:sticky;top:0;z-index:50;background:#14161a;border-bottom:1px solid var(--line);}
    .wrap{padding:12px 14px;display:flex;align-items:center;gap:10px}
    .actions{margin-left:auto;display:flex;gap:10px}
    .iconbtn{position:relative;display:grid;place-items:center;width:38px;height:38px;
      border-radius:12px;background:#1a1f27;border:1px solid var(--line);color:var(--txt);cursor:pointer}
    .badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;padding:0 5px;
      background:linear-gradient(180deg,#f97316,#ea580c);color:#fff;border-radius:999px;
      font-size:11px;display:grid;place-items:center;font-weight:800}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="wrap">
        <div class="brand">üçî <strong>Clena Foods</strong></div>
        <div class="actions">
          <button class="iconbtn" id="btnMap"><i class="fa-solid fa-location-dot"></i></button>
          <button class="iconbtn" id="btnCart">
            <i class="fa-solid fa-bag-shopping"></i>
            <span class="badge" id="cartBadge">0</span>
          </button>
          <button class="iconbtn" id="btnInstall" style="display:none"><i class="fa-solid fa-download"></i></button>
          <!-- üîî Notifica√ß√µes -->
          <button class="iconbtn" id="btnNotif">
            <i class="fa-solid fa-bell"></i>
            <span class="badge hidden" id="notifBadge">0</span>
          </button>
          <button class="iconbtn" id="btnPerfil"><i class="fa-solid fa-user"></i></button>
        </div>
      </div>
    </header>

    <main>
      <section id="page-menu"> ... card√°pio ... </section>
      <section class="hidden" id="page-perfil"> ... perfil ... </section>
    </main>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxjGPNBX27DtQzIziM-tlsjVzxOt9bV9RP4TDgZWEIhJVnoowTtfIxlWepYedltBbVy/exec';
const store = {
  get(k,def){ try{return JSON.parse(localStorage.getItem(k)) ?? def}catch{return def}},
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)) },
  del(k){ localStorage.removeItem(k) }
};
let user = store.get('cf_user', null);
let token = store.get('cf_token', null);

/* ===== API helper ===== */
async function api(acao, payload = {}) {
  try {
    const res = await fetch(API_URL, { method:'POST', body: JSON.stringify({ acao, token, ...payload }) });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch(e){ throw new Error(`Resposta n√£o-JSON: ${text.slice(0,80)}`); }
    if(!res.ok || data.ok===false) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  } catch (e) {
    console.error('API', acao, e);
    if (acao !== 'pollNotifications') { // n√£o incomodar a cada 10s
      alert(`Erro na API (${acao}): ${e.message}`);
    }
    return { ok:false, error: e.message };
  }
}

/* ===== Notifica√ß√µes ===== */
let notifSince = Number(store.get('cf_notif_since', Date.now()-3600*1000));
let pollTimer = null;
let notifCount = 0;

function isPerfilVisible(){
  const el = document.getElementById('page-perfil');
  return el && !el.classList.contains('hidden') && !document.hidden;
}

function setupNotifications(){
  if('Notification' in window && Notification.permission==='default'){
    setTimeout(()=> Notification.requestPermission().catch(()=>{}), 800);
  }
  const bell = document.getElementById('btnNotif');
  if (bell && !bell.dataset.bound){
    bell.addEventListener('click', goToPerfilAndClear);
    bell.dataset.bound = '1';
  }
  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden && isPerfilVisible()){
      notifCount = 0; updateNotifBadge(0);
    }
  });
  startPolling();
}

function startPolling(){
  if(pollTimer) clearTimeout(pollTimer);
  const loop = async ()=>{
    try{
      if(!user){ pollTimer = setTimeout(loop, 10000); return; }
      const r = await api('pollNotifications', { since: notifSince });
      if(r.ok && Array.isArray(r.items)){
        const items = r.items.map(it => {
          const ts = typeof it.created_at === 'number'
            ? it.created_at
            : Date.parse(it.created_at || '') || Date.now();
          return { ...it, _ts: ts };
        });
        items.forEach(showNotification);
        const maxTs = items.reduce((m, it)=> Math.max(m, it._ts), notifSince);
        if(maxTs > notifSince){ notifSince = maxTs; store.set('cf_notif_since', notifSince); }
      }
    }catch(e){ console.warn('pollNotifications erro', e); }
    pollTimer = setTimeout(loop, 10000);
  };
  loop();
}

function updateNotifBadge(count){
  const badge = document.getElementById('notifBadge');
  if(!badge) return;
  if(count > 0){
    badge.textContent = count;
    badge.classList.remove('hidden');
  }else{
    badge.classList.add('hidden');
  }
}

function goToPerfilAndClear(){
  notifCount = 0;
  updateNotifBadge(0);
  showPage('perfil');
}

function showNotification(n){
  const title = n.title || 'Atualiza√ß√£o do pedido';
  const body  = n.message || '';
  if (isPerfilVisible()){
    if(n.order_id) fetchOrders?.({showSkeleton:false});
    return;
  }
  if('Notification' in window && Notification.permission==='granted'){
    const note = new Notification(title, { body });
    note.onclick = ()=> { window.focus(); goToPerfilAndClear(); };
  } else {
    alert(`${title}\n\n${body}`);
  }
  notifCount++;
  updateNotifBadge(notifCount);
  if(n.order_id) fetchOrders?.({showSkeleton:false});
}

/* ===== Navega√ß√£o simples ===== */
function showPage(id){
  document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
  document.getElementById('page-'+id)?.classList.remove('hidden');
}

/* ===== Boot ===== */
(function init(){
  setupNotifications();
})();
</script>
</body>
</html>
