<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <!-- SOMENTE CELULAR + ZOOM BLOQUEADO -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Clena Foods ‚Ä¢ Card√°pio & Pedidos</title>
  <meta name="description" content="Cat√°logo de produtos, complementos e pedidos com login por WhatsApp + senha e pagamento PIX (QR Code)." />

  <!-- √çcones e fontes -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    :root{
      --bg:#0e0f12; --panel:#14161a; --soft:#1a1f27; --line:#262b36;
      --brand:#e63946; --brand-2:#ff8f1f; --txt:#f7f8fa; --muted:#cbd5e1;
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --shadow: 0 12px 28px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1000px 600px at 10% -20%, rgba(230,57,70,.12), transparent),
                      radial-gradient(800px 500px at 110% 10%, rgba(255,143,31,.10), transparent), var(--bg);
      color:var(--txt);font-family:Inter, system-ui, Arial, sans-serif;}

    /* ===== BLOQUEIO DESKTOP/TABLET ===== */
    #desktopBlocker{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; text-align:center;
      padding:24px; background:linear-gradient(180deg,#0e0f12,#0b0c10); color:var(--txt); z-index:99999;
    }
    #desktopBlocker .box{
      max-width:560px; background:linear-gradient(180deg,#171a20,#14161b);
      border:1px solid var(--line); border-radius:16px; padding:24px; box-shadow:var(--shadow)
    }
    #desktopBlocker h1{margin:0 0 8px; font-size:22px}
    #desktopBlocker p{margin:0; color:var(--muted)}
    @media (min-width: 768px){
      #app{display:none !important}
      #desktopBlocker{display:flex}
    }

    /* ===== NAVBAR ===== */
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(1.2) blur(10px);
      background:linear-gradient(180deg, rgba(20,22,26,.92), rgba(20,22,26,.6));
      border-bottom:1px solid var(--line);
    }
    .wrap{padding:12px 14px; display:flex; align-items:center; gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:34px;height:34px;border-radius:10px;box-shadow:var(--shadow)}
    .brand .t1{font-weight:800;letter-spacing:.2px;font-size:15px}
    .brand .t2{font-size:11px;color:var(--muted)}

    .actions{margin-left:auto; display:flex; align-items:center; gap:10px}
    .iconbtn{
      position:relative; display:grid; place-items:center;
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(180deg,#1a1f27,#14181f);
      border:1px solid var(--line); color:var(--txt);
    }
    .badge{
      position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; padding:0 5px;
      background:linear-gradient(180deg,#f97316,#ea580c); color:#fff; border-radius:999px;
      font-size:11px; display:grid; place-items:center; font-weight:800; box-shadow:0 2px 6px rgba(0,0,0,.4);
    }

    /* ===== BUSCA + CATEGORIAS ===== */
    .topbar{padding:10px 14px; display:flex; gap:10px; align-items:center}
    .search{flex:1; display:flex; gap:8px; align-items:center;
      background:linear-gradient(180deg,#12161c,#0f1318); border:1px solid var(--line);
      border-radius:12px; padding:10px 12px}
    .search input{flex:1; background:transparent; border:0; outline:none; color:var(--txt); font-size:14px}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0f1115;border:1px solid var(--line);border-radius:12px;padding:8px 10px;font-size:12px;color:var(--muted)}

    .cats{
      padding:0 14px 8px 14px; display:flex; gap:8px; overflow:auto;
      mask-image: linear-gradient(90deg, transparent 0, #000 25px, #000 calc(100% - 25px), transparent 100%);
    }
    .chip{flex:0 0 auto; padding:8px 12px; border-radius:999px; border:1px solid var(--line);
      background:linear-gradient(180deg,#1a1f27,#14181f); color:var(--txt); font-weight:600}
    .chip.active{outline:2px solid #2f3542}

    /* ===== GRID DE PRODUTOS ===== */
    .page{padding:8px 14px 0}
    .cards{display:grid; grid-template-columns:1fr; gap:12px}
    .card{
      display:grid; grid-template-columns:86px 1fr; gap:10px;
      background:linear-gradient(180deg,#151921,#12161c);
      border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:var(--shadow);
    }
    .card .img{width:86px; height:86px; overflow:hidden; border-right:1px solid var(--line)}
    .card .img img{width:100%;height:100%;object-fit:cover;display:block; transition:transform .35s ease}
    .card:active .img img{transform:scale(1.05)}
    .card .body{padding:10px 10px 10px 0}
    .name{font-weight:800; font-size:14px}
    .desc{color:var(--muted); font-size:12px; line-height:1.25; margin:3px 0 6px}
    .price{font-weight:800;color:#fcd34d}
    .btn{appearance:none;border:0;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg, #f97316, #ea580c);color:white;font-weight:800}
    .btn.secondary{background:linear-gradient(180deg, #2b3240, #1c222c)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}

    /* ===== MAPA ‚ÄúABERTO NA TELA‚Äù ===== */
    #mapWrap{position:fixed; left:0; right:0; bottom:0; height:34vh; z-index:20;
      background:#0f1115; border-top:1px solid var(--line); box-shadow:0 -10px 30px rgba(0,0,0,.3)}
    #map{width:100%; height:100%}
    .mapHeader{
      position:absolute; top:6px; left:10px; right:10px; z-index:10;
      display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .mapTag{background:rgba(0,0,0,.5); border:1px solid var(--line); color:#fff; padding:6px 10px; border-radius:10px; font-size:12px}
    .spacer{height:36vh} /* para o conte√∫do n√£o ficar escondido atr√°s do mapa */

    /* ===== DRAWER DO CARRINHO ===== */
    #cartDrawer{
      position:fixed; top:0; right:0; bottom:0; width:92vw; max-width:420px; z-index:60;
      background:linear-gradient(180deg,#161a22,#12161c); border-left:1px solid var(--line);
      transform:translateX(100%); transition:.28s ease; box-shadow:var(--shadow);
      display:flex; flex-direction:column;
    }
    #cartDrawer.open{transform:translateX(0)}
    .drawerHead{display:flex; align-items:center; gap:8px; padding:14px; border-bottom:1px solid var(--line)}
    .drawerBody{flex:1; overflow:auto; padding:12px}
    .drawerFoot{padding:12px; border-top:1px solid var(--line); display:grid; gap:10px}
    .row{display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #283141}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:28px;height:28px;border-radius:10px;background:#0f1115;border:1px solid var(--line);color:var(--txt)}
    .totalLine{display:flex; justify-content:space-between; font-size:16px; font-weight:800}
    .empty{color:var(--muted); text-align:center; padding:14px}

    /* Modais */
    dialog{border:0;border-radius:16px;background:linear-gradient(180deg, #181b22, #14171d);color:var(--txt);width:min(680px,calc(100vw - 24px));box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .hidden{display:none !important}
  </style>
</head>
<body>
  <!-- BLOQUEIO PARA N√ÉO-M√ìVEIS -->
  <div id="desktopBlocker" aria-hidden="true">
    <div class="box">
      <div style="font-size:42px;line-height:1;margin-bottom:8px">üì±</div>
      <h1>Abra no celular</h1>
      <p>Este aplicativo foi otimizado exclusivamente para dispositivos m√≥veis.<br/>Acesse pelo seu smartphone para continuar.</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <!-- NAV -->
    <header>
      <div class="wrap">
        <div class="brand">
          <img src="https://images.unsplash.com/photo-1544027993-37dbfe43562a?q=80&w=120&auto=format&fit=crop" alt="logo"/>
          <div>
            <div class="t1">CLENA FOODS</div>
            <div class="t2">Hamburgueria ‚Ä¢ Delivery & Retirada</div>
          </div>
        </div>
        <div class="actions">
          <button class="iconbtn" id="btnMapFocus" title="Centralizar no mapa"><i class="fa-solid fa-location-dot"></i></button>
          <button class="iconbtn" id="btnCart" title="Carrinho">
            <i class="fa-solid fa-bag-shopping"></i>
            <span class="badge" id="cartBadge">0</span>
          </button>
          <button class="iconbtn" onclick="showPage('perfil')" title="Perfil"><i class="fa-solid fa-user"></i></button>
        </div>
      </div>

      <div class="topbar">
        <div class="search">
          <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8"></i>
          <input id="search" placeholder="Buscar por nome, descri√ß√£o ou ingrediente‚Ä¶" />
        </div>
        <span class="pill" id="deliveryArea"><i class="fa-solid fa-motorcycle"></i>&nbsp; Entrega: consulte CEP</span>
      </div>

      <div class="cats" id="cats"></div>
    </header>

    <!-- CONTE√öDO -->
    <section class="page" id="page-menu">
      <div class="cards" id="menuGrid"></div>
      <div class="spacer"></div>
    </section>

    <!-- P√ÅGINAS EXTRAS (mesmas do seu projeto) -->
    <section class="page hidden" id="page-complementos"><div class="cards" id="compsGrid"></div><div class="spacer"></div></section>
    <section class="page hidden" id="page-pedidos">
      <h2>Checkout</h2>
      <div class="grid2">
        <label>
          <div>Forma de Entrega</div>
          <div style="display:flex;gap:8px">
            <button id="entregaBtn" class="btn secondary" onclick="setEntrega('delivery')">Entrega</button>
            <button class="btn secondary" onclick="setEntrega('pickup')">Retirada</button>
          </div>
        </label>
        <label>
          <div>Pagamento</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button data-pay="credito" class="btn secondary" onclick="selPay(this)"><i class="fa-solid fa-credit-card"></i> Cr√©dito</button>
            <button data-pay="debito" class="btn secondary" onclick="selPay(this)">D√©bito</button>
            <button data-pay="dinheiro" class="btn secondary" onclick="selPay(this)">Dinheiro</button>
            <button data-pay="pix" class="btn secondary" onclick="selPay(this)">PIX</button>
          </div>
        </label>
      </div>
      <div id="pixBox" class="hidden" style="margin-top:12px;border:1px dashed #334155;padding:12px;border-radius:12px">
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
          <canvas id="pixQr" width="160" height="160" style="background:#0f1115;border-radius:8px;border:1px solid var(--line)"></canvas>
          <div style="flex:1;min-width:240px">
            <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
              <strong>PIX ‚Äì Copia e Cola</strong>
              <button class="btn secondary" onclick="copyPix()"><i class="fa-regular fa-copy"></i> Copiar</button>
            </div>
            <textarea id="pixCop" rows="3" style="width:100%;margin-top:8px;background:#0f1115;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:8px" readonly></textarea>
            <small style="color:var(--muted)">Ap√≥s o pagamento, seu pedido √© confirmado automaticamente.</small>
          </div>
        </div>
      </div>
      <div id="checkoutList" style="margin-top:8px"></div>
      <div class="row" style="border-top:1px dashed #334155"><span>Total</span><strong id="checkoutTotal">R$ 0,00</strong></div>
      <button class="btn" style="margin-top:12px" onclick="finishOrder()"><i class="fa-solid fa-paper-plane"></i> Confirmar Pedido</button>
      <div class="spacer"></div>
    </section>

    <section class="page hidden" id="page-perfil">
      <h2>Minha Conta</h2>
      <form id="loginBox" class="block">
        <h3>Entrar</h3>
        <label>WhatsApp
          <input id="pwa" class="input" placeholder="(71) 90000-0000"/>
        </label>
        <label>Senha
          <input id="ppw" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </label>
        <button type="button" class="btn" onclick="login()"><i class="fa-solid fa-right-to-bracket"></i> Entrar</button>
        <p style="color:var(--muted);font-size:13px">N√£o tem cadastro? Role para criar.</p>
      </form>

      <form id="signupBox" class="block" style="margin-top:12px">
        <h3>Criar conta</h3>
        <div class="grid2">
          <label>Nome completo <input id="s-nome" class="input"/></label>
          <label>WhatsApp <input id="s-wa" class="input" placeholder="(71) 90000-0000"/></label>
          <label>E-mail <input id="s-mail" class="input"/></label>
          <label>Senha <input id="s-senha" type="password" class="input"/></label>
          <label>CPF (opcional) <input id="s-cpf" class="input"/></label>
          <label>Nascimento (opcional) <input id="s-nasc" type="date" class="input"/></label>
        </div>
        <button type="button" class="btn" onclick="signup()"><i class="fa-solid fa-user-plus"></i> Cadastrar</button>
      </form>
      <div id="profileBox" class="hidden" style="margin-top:16px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:48px;height:48px;border-radius:50%;background:#0f1115;border:1px solid var(--line);display:grid;place-items:center"><i class="fa-solid fa-user"></i></div>
          <div><div id="uNome" style="font-weight:800"></div><div id="uWa" style="color:var(--muted);font-size:13px"></div></div>
          <div style="margin-left:auto"><button class="btn secondary" onclick="logout()">Sair</button></div>
        </div>
      </div>
      <div class="spacer"></div>
    </section>

    <!-- MAPA FIXO -->
    <div id="mapWrap">
      <div class="mapHeader">
        <div class="mapTag"><i class="fa-solid fa-store"></i> Retirada: Pituba, Salvador-BA</div>
        <div class="mapTag" id="mapStatus">üìç Localizando‚Ä¶</div>
      </div>
      <div id="map"></div>
    </div>

    <!-- DIALOGS -->
    <dialog id="dlgItem"><div id="itemBox"></div></dialog>
  </div><!-- /#app -->

  <!-- DRAWER DO CARRINHO -->
  <aside id="cartDrawer" aria-hidden="true">
    <div class="drawerHead">
      <button class="iconbtn" onclick="toggleCart(false)"><i class="fa-solid fa-chevron-right"></i></button>
      <strong style="font-size:16px">Meu Carrinho</strong>
    </div>
    <div class="drawerBody" id="cartItems"></div>
    <div class="drawerFoot">
      <div class="totalLine"><span>Subtotal</span><strong id="subTotal">R$ 0,00</strong></div>
      <div class="totalLine" style="font-size:14px;opacity:.8"><span>Entrega</span><strong id="shipTax">‚Äî</strong></div>
      <div class="totalLine" style="border-top:1px dashed #334155; padding-top:8px"><span>Total</span><strong id="grandTotal">R$ 0,00</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn secondary" style="flex:1" onclick="clearCart()"><i class="fa-solid fa-trash"></i> Limpar</button>
        <button class="btn" style="flex:2" onclick="goCheckout()"><i class="fa-solid fa-credit-card"></i> Finalizar</button>
      </div>
    </div>
  </aside>

  <style>
    .input{width:100%;margin-top:4px;padding:12px;border-radius:12px;background:#0f1115;border:1px solid var(--line);color:var(--txt)}
    .block{background:linear-gradient(180deg,#171a20,#14161b);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  </style>

  <script>
  /* ===== Enforce mobile only ===== */
  (function enforceMobileOnly(){
    const isUA = /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isSmall = Math.min(window.innerWidth, window.innerHeight) < 768;
    const allow = isUA && isSmall;
    document.getElementById('desktopBlocker').style.display = allow ? 'none' : 'flex';
    const app = document.getElementById('app');
    if(app) app.style.display = allow ? '' : 'none';
    let to=null;
    const rerun=()=>{clearTimeout(to); to=setTimeout(enforceMobileOnly,150)};
    window.addEventListener('resize',rerun); window.addEventListener('orientationchange',rerun);
  })();

  // ========================== CONFIGURA√á√ÉO ===============================
  const API_URL = 'https://script.google.com/macros/s/SEU_WEBAPP_AQUI/exec'; // <- Apps Script WebApp
  const PIX_CHAVE = 'SEU_PIX_AQUI'; // chave aleat√≥ria/CNPJ/CPF/telefone/email
  const PIX_RECEPTOR = 'CLENA FOODS';
  const PIX_CIDADE = 'SALVADOR';
  // ======================================================================

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const BRL = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const store = {
    get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
    set(k,v){ localStorage.setItem(k, JSON.stringify(v)) },
    del(k){ localStorage.removeItem(k) }
  }

  let user = store.get('cf_user', null);
  let token = store.get('cf_token', null);
  let cart = store.get('cf_cart', []);
  let entrega = 'delivery';
  let payMethod = 'credito';
  let menu = [];
  let complements = [];

  const pages = ['menu','complementos','pedidos','perfil'];

  // NAV intera√ß√µes
  $('#btnCart').onclick = ()=> toggleCart(true);
  function toggleCart(open){
    const dr = document.getElementById('cartDrawer');
    dr.classList.toggle('open', open);
    dr.setAttribute('aria-hidden', open? 'false':'true');
  }

  // Busca + filtros
  document.getElementById('search').addEventListener('input', renderMenu);

  // API helper
  async function api(acao, payload={}){
    try{
      const res = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({acao, token, ...payload})});
      const data = await res.json();
      if(data.error) throw new Error(data.error);
      return data;
    }catch(e){ console.error('API', acao, e); return {ok:false, error: e.message} }
  }

  // Carregar dados iniciais
  (async function init(){
    $$('#cats').forEach(e=>e.innerHTML='');
    await loadMenu();
    await loadComplements();
    initMap();
    if(user) applyUser();
    renderCart(); // atualiza badge + drawer
  })();

  async function loadMenu(){
    const data = await api('getMenu');
    if(data.ok){ menu = data.items; } else {
      // ===== Fallback: exemplo local (MAIS PRODUTOS) =====
      menu = [
        {id:'x1', name:'Cheeseburger Clena', desc:'Brioche, burger 160g, queijo e molho da casa.', price:27.9, cat:'Burgers', img:'https://images.unsplash.com/photo-1550317138-10000687a72b?q=80&w=800&auto=format&fit=crop'},
        {id:'x2', name:'Smash Duplo', desc:'Dois blends 90g, cheddar, cebola.', price:31.9, cat:'Burgers', img:'https://images.unsplash.com/photo-1561758033-d89a9ad46330?q=80&w=800&auto=format&fit=crop'},
        {id:'x5', name:'Clena Bacon', desc:'Burger 160g, cheddar, bacon crocante.', price:33.9, cat:'Burgers', img:'https://images.unsplash.com/photo-1550547660-d9450f859349?q=80&w=800&auto=format&fit=crop'},
        {id:'x6', name:'Veggie Green', desc:'Burger de gr√£o-de-bico, salada e maionese verde.', price:29.9, cat:'Burgers', img:'https://images.unsplash.com/photo-1550547660-16a0e0a1e5c2?q=80&w=800&auto=format&fit=crop'},
        {id:'x3', name:'Batata R√∫stica', desc:'P√°prica e alho.', price:15.9, cat:'Acompanhamentos', img:'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=800&auto=format&fit=crop'},
        {id:'x7', name:'Onion Rings', desc:'An√©is de cebola empanados.', price:16.9, cat:'Acompanhamentos', img:'https://images.unsplash.com/photo-1552332386-f8dd00dc2f85?q=80&w=800&auto=format&fit=crop'},
        {id:'d1', name:'Brownie Clena', desc:'Brownie com calda quente.', price:14.9, cat:'Sobremesas', img:'https://images.unsplash.com/photo-1606313564200-e75d5e30476e?q=80&w=800&auto=format&fit=crop'},
        {id:'d2', name:'Milkshake Ovomaltine', desc:'300 ml', price:17.9, cat:'Sobremesas', img:'https://images.unsplash.com/photo-1499636136210-6f4ee915583e?q=80&w=800&auto=format&fit=crop'},
        {id:'b1', name:'Refrigerante Lata', desc:'350 ml', price:6.0, cat:'Bebidas', img:'https://images.unsplash.com/photo-1541976076758-347942db1970?q=80&w=800&auto=format&fit=crop'},
        {id:'b2', name:'Suco Natural', desc:'Laranja ou lim√£o.', price:9.0, cat:'Bebidas', img:'https://images.unsplash.com/photo-1542442828-287ea90b6b32?q=80&w=800&auto=format&fit=crop'},
        {id:'p1', name:'Combo Clena', desc:'Burger + Batata + Refri', price:42.9, cat:'Combos', img:'https://images.unsplash.com/photo-1550547660-1c00da094a4b?q=80&w=800&auto=format&fit=crop'},
        {id:'p2', name:'Combo Fam√≠lia', desc:'2 Burgers + 2 Acomp. + 2 Bebidas', price:89.9, cat:'Combos', img:'https://images.unsplash.com/photo-1550547660-08490b1b65f6?q=80&w=800&auto=format&fit=crop'}
      ];
    }
    renderCategories();
    renderMenu();
  }

  async function loadComplements(){
    const data = await api('getComplements');
    complements = data.ok ? data.items : [
      {id:'c1', name:'Bacon', price:4.0, tag:'Adicionais'},
      {id:'c2', name:'Cheddar extra', price:3.5, tag:'Adicionais'},
      {id:'c3', name:'Molho Clena', price:2.5, tag:'Molhos'},
      {id:'c4', name:'Barbecue', price:2.5, tag:'Molhos'},
    ];
  }

  function renderCategories(){
    const cats = ['Tudo', ...new Set(menu.map(i=> i.cat))];
    const box = document.getElementById('cats'); box.innerHTML='';
    cats.forEach((c,ix)=>{
      const chip = document.createElement('button'); chip.className='chip'+(ix===0?' active':''); chip.textContent=c;
      chip.onclick=()=>{ $$('#cats .chip').forEach(x=>x.classList.remove('active')); chip.classList.add('active'); renderMenu(c==='Tudo'? null : c) };
      box.appendChild(chip);
    });
  }

  function renderMenu(activeCat){
    const q = document.getElementById('search').value.toLowerCase();
    const grid = document.getElementById('menuGrid'); grid.innerHTML='';
    menu
      .filter(i => (!activeCat || i.cat===activeCat) && (i.name.toLowerCase().includes(q) || (i.desc||'').toLowerCase().includes(q)))
      .forEach(i => grid.appendChild(cardItem(i)));
  }

  function cardItem(i){
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="img"><img src="${i.img}" alt="${i.name}" loading="lazy"></div>
      <div class="body">
        <div class="name">${i.name}</div>
        <div class="desc">${i.desc||''}</div>
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="price">${BRL(i.price)}</div>
          <button class="btn" onclick='openItem(${JSON.stringify(i)})'>Adicionar</button>
        </div>
      </div>`;
    return el;
  }

  // ITEM
  function openItem(i){
    const compHtml = complements.map(c=>
      `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-compid="${c.id}" data-compprice="${c.price}"/> ${c.name} <span style="margin-left:auto">${BRL(c.price)}</span></label>`
    ).join('');
    const html = `
      <div class="grid2" style="gap:16px">
        <div><img src="${i.img}" alt="${i.name}" style="width:100%;border-radius:12px;border:1px solid var(--line)"/></div>
        <div>
          <h3 style="margin:0">${i.name}</h3>
          <p style="color:var(--muted)">${i.desc||''}</p>
          <div class="pill" style="margin:8px 0">Pre√ßo base <strong>${BRL(i.price)}</strong></div>
          <h4>Complementos</h4>
          <div style="display:grid;gap:6px;max-height:180px;overflow:auto;padding-right:6px">${compHtml||'<em style="color:var(--muted)">Nenhum complemento cadastrado</em>'}</div>
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <button class="btn" id="addBtn">Adicionar ao carrinho</button>
            <button class="btn secondary" onclick="dlgItem.close()">Cancelar</button>
          </div>
        </div>
      </div>`;
    document.getElementById('itemBox').innerHTML = html;
    document.getElementById('addBtn').onclick = () => {
      const chec = Array.from(document.getElementById('dlgItem').querySelectorAll('input[type=checkbox]:checked'))
                  .map(ch => ({ id: ch.dataset.compid, name: complements.find(c=>c.id===ch.dataset.compid)?.name || 'Extra', price: Number(ch.dataset.compprice) }));
      addToCart({ id:i.id, name:i.name, price:i.price, qty:1, img:i.img, comps:chec });
      dlgItem.close();
      toggleCart(true);
    }
    document.getElementById('dlgItem').showModal();
  }

  // CARRINHO
  function addToCart(item){
    const k = JSON.stringify({id:item.id, comps:item.comps.map(c=>c.id).sort()});
    const found = cart.find(x => JSON.stringify({id:x.id, comps:x.comps.map(c=>c.id).sort()})===k);
    if(found){ found.qty += 1 } else { cart.push(item) }
    store.set('cf_cart', cart); renderCart();
  }
  function inc(i){ cart[i].qty++; store.set('cf_cart',cart); renderCart() }
  function dec(i){ cart[i].qty>1? cart[i].qty-- : cart.splice(i,1); store.set('cf_cart',cart); renderCart() }
  function clearCart(){ cart=[]; store.set('cf_cart',cart); renderCart() }

  function renderCart(){
    // Badge
    const count = cart.reduce((a,b)=>a+b.qty,0);
    document.getElementById('cartBadge').textContent = count;

    // Drawer
    const box = document.getElementById('cartItems'); box.innerHTML='';
    if(!cart.length){
      box.innerHTML = `<div class="empty">Seu carrinho est√° vazio.</div>`;
    }else{
      cart.forEach((it,ix)=>{
        const extras = it.comps?.length? `<div style="color:var(--muted);font-size:12px">+ ${it.comps.map(c=>c.name).join(', ')}</div>` : '';
        const total = (it.price + (it.comps||[]).reduce((a,b)=>a+b.price,0)) * it.qty;
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `
          <div style="max-width:58%">
            <div style="font-weight:600">${it.name}</div>
            ${extras}
          </div>
          <div class="qty">
            <button onclick="dec(${ix})">-</button><span>${it.qty}</span><button onclick="inc(${ix})">+</button>
            <strong style="width:86px;text-align:right">${BRL(total)}</strong>
          </div>`;
        box.appendChild(row);
      });
    }
    const sub = cart.reduce((a,it)=> a + (it.price + (it.comps||[]).reduce((x,y)=>x+y.price,0)) * it.qty, 0);
    document.getElementById('subTotal').textContent = BRL(sub);
    document.getElementById('shipTax').textContent = entrega==='delivery' ? 'A calcular' : BRL(0);
    document.getElementById('grandTotal').textContent = BRL(sub);
    renderCheckout();
  }

  function goCheckout(){ showPage('pedidos'); toggleCart(false); window.scrollTo({top:0,behavior:'smooth'}) }

  function setEntrega(m){ 
    entrega = m; 
    document.getElementById('mapStatus').textContent = m==='delivery' ? 'üöö Entrega selecionada' : 'üèÅ Retirada selecionada';
    renderCart();
  }
  function selPay(btn){
    $$('#page-pedidos [data-pay]').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active'); 
    payMethod = btn.dataset.pay; 
    document.getElementById('pixBox').classList.toggle('hidden', payMethod!=='pix'); 
    if(payMethod==='pix') createPix();
  }

  function renderCheckout(){
    const box = document.getElementById('checkoutList'); if(!box) return;
    box.innerHTML='';
    let total = 0;
    cart.forEach(it=>{
      const extras = it.comps?.length? ` (+${it.comps.map(c=>c.name).join(', ')})` : '';
      const t = (it.price + (it.comps||[]).reduce((a,b)=>a+b.price,0)) * it.qty; total += t;
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<span>${it.qty}√ó ${it.name}${extras}</span><strong>${BRL(t)}</strong>`;
      box.appendChild(row);
    });
    const el = document.getElementById('checkoutTotal'); if(el) el.textContent = BRL(total);
    if(payMethod==='pix') createPix();
  }

  // PIX
  function emv(field, value){ const len = String(value.length).padStart(2,'0'); return field + len + value }
  function pixPayload({nome, cidade, chave, valor, txid='CF' + Date.now().toString().slice(-8)}){
    const method = emv('00','BR.GOV.BCB.PIX') + (chave? emv('01', chave):'');
    const mer = emv('26', method); const cat = emv('52','0000'); const curr = emv('53','986');
    const amount = valor? emv('54', String(valor.toFixed(2))) : ''; const ctry = emv('58','BR');
    const city = emv('60', (cidade||'BRASILIA').substring(0,15).toUpperCase());
    const name = emv('59', (nome||'RECEBEDOR').substring(0,25).toUpperCase());
    const add = emv('62', emv('05', txid.substring(0,25)));
    let body = emv('00','01') + emv('01','12') + mer + cat + curr + amount + ctry + name + city + add + '6304';
    const crc = crc16(body).toUpperCase(); return body + crc;
  }
  function crc16(str){
    let crc = 0xFFFF;
    for(let i=0;i<str.length;i++){
      crc ^= str.charCodeAt(i) << 8;
      for(let j=0;j<8;j++) crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : (crc << 1);
      crc &= 0xFFFF;
    }
    return crc.toString(16).padStart(4,'0');
  }
  function createPix(){
    const total = cart.reduce((a,it)=> a + (it.price + (it.comps||[]).reduce((x,y)=>x+y.price,0)) * it.qty, 0);
    const payload = pixPayload({nome: PIX_RECEPTOR, cidade: PIX_CIDADE, chave: PIX_CHAVE, valor: total});
    const ta = document.getElementById('pixCop'); if(ta) ta.value = payload;
    const cv = document.getElementById('pixQr'); if(cv) new QRious({element: cv, value: payload, size: 160});
  }
  function copyPix(){
    const ta = document.getElementById('pixCop'); ta.select(); document.execCommand('copy');
    alert('C√≥digo PIX copiado!');
  }

  // AUTH
  function applyUser(){
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('signupBox').classList.add('hidden');
    document.getElementById('profileBox').classList.remove('hidden');
    document.getElementById('uNome').textContent = user?.nome || 'Cliente';
    document.getElementById('uWa').textContent = user?.whatsapp || '';
  }
  async function login(){
    const whatsapp = document.getElementById('pwa').value.trim();
    const senha = document.getElementById('ppw').value.trim();
    const r = await api('login', {whatsapp, senha});
    if(r.ok){ user=r.user; token=r.token; store.set('cf_user',user); store.set('cf_token',token); applyUser(); alert('Bem-vindo!') } else alert('Falha no login: '+(r.error||''))
  }
  async function signup(){
    const payload = { nome:document.getElementById('s-nome').value.trim(), whatsapp:document.getElementById('s-wa').value.trim(), email:document.getElementById('s-mail').value.trim(), senha:document.getElementById('s-senha').value.trim(), cpf:document.getElementById('s-cpf').value.trim(), nasc:document.getElementById('s-nasc').value }
    const r = await api('signup', payload);
    if(r.ok){ alert('Cadastro realizado! Fa√ßa o login.'); showPage('perfil'); } else alert('Erro no cadastro: '+(r.error||''))
  }
  function logout(){ user=null; token=null; store.del('cf_user'); store.del('cf_token'); location.reload() }

  // NAVEGA√á√ÉO
  function showPage(id){
    pages.forEach(p=> document.getElementById('page-'+p)?.classList.toggle('hidden', p!==id));
    window.scrollTo(0,0);
  }

  // MAPA
  let map, userMarker, storeMarker;
  function initMap(){
    map = L.map('map', {zoomControl:false}).setView([-12.9822, -38.4556], 13); // Salvador
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '&copy; OpenStreetMap'}).addTo(map);
    storeMarker = L.marker([-12.9979, -38.4510]).addTo(map).bindPopup('Clena Foods - Retirada');
    // Tenta geolocaliza√ß√£o
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        if(userMarker) userMarker.remove();
        userMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('Voc√™');
        map.setView([latitude, longitude], 14);
        document.getElementById('mapStatus').textContent = '‚úÖ Localiza√ß√£o ativa';
      }, ()=> document.getElementById('mapStatus').textContent = '‚ö†Ô∏è Sem acesso √† localiza√ß√£o');
    }else{
      document.getElementById('mapStatus').textContent = '‚ÑπÔ∏è Geolocaliza√ß√£o indispon√≠vel';
    }
    document.getElementById('btnMapFocus').onclick = ()=>{
      if(userMarker){ map.setView(userMarker.getLatLng(), 15); userMarker.openPopup(); }
      else { map.setView(storeMarker.getLatLng(), 15); storeMarker.openPopup(); }
    };
  }
  </script>
</body>
</html>
